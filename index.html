<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>National Account Property List</title>

  <!-- Amplify lib (safe to keep; not used for auth in dev mode) -->
  <script src="https://unpkg.com/aws-amplify@5.3.12/dist/aws-amplify.min.js"></script>

  <!-- Config (stubbed while auth is bypassed) -->
  <script src="/auth-config.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Sage UI test', Roboto, sans-serif;
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
      color: #111;
      min-height: 100vh;
    }
    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 2rem 0;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .header p { font-size: 1.1rem; opacity: 0.9; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .search-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    .search-box {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 1rem;
      transition: border-color 0.3s ease;
    }
    .search-box:focus {
      outline: none;
      border-color: #2B73B5;
      box-shadow: 0 0 0 3px rgba(43, 115, 181, 0.1);
    }
    .stats { text-align: center; color: #666; margin-bottom: 1rem; font-weight: 500; }
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    .records-grid { display: grid; gap: 1.5rem; }
    .record-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
    }
    .record-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); }
    .record-header {
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .expand-icon { font-size: 1.5rem; transition: transform 0.3s ease; }
    .record-card.expanded .expand-icon { transform: rotate(180deg); }
    .record-content { padding: 0; max-height: 0; overflow: hidden; transition: all 0.3s ease; }
    .record-card.expanded .record-content { padding: 1.5rem; max-height: none; }
    .field-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 0.75rem; align-items: start; }
    .field-label {
      font-weight: 600;
      color: #1F4788;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9rem;
    }
    .field-value {
      padding: 0.75rem 0;
      border-bottom: 1px solid #f0f0f0;
      word-break: break-word;
      line-height: 1.5;
    }
    .no-results {
      text-align: center;
      padding: 3rem;
      color: #666;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    .bms-badge {
      display: inline-block;
      background: #F47920;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 1rem;
    }
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
    }
    .auth-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 420px;
      width: 90%;
    }
    .auth-button {
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 1rem;
    }
    .auth-button:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(31, 71, 136, 0.3); }
    .user-info {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }
    .logout-btn {
      background: #F47920;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .hidden { display: none; }
  </style>
</head>

<body>
  <!-- Authentication Screen (DEV MODE: hidden immediately) -->
  <div id="authScreen" class="auth-container">
    <div class="auth-card">
      <h1>National Account Property <span class="bms-badge">BMS</span></h1>
      <p style="margin: 1rem 0; color: #666;">Secure access via Okta Verify</p>
      <button id="loginBtn" class="auth-button">Sign In with OKTA</button>
    </div>
  </div>

  <!-- Main Application (DEV MODE: shown immediately by JS) -->
  <div id="mainApp" class="hidden">
    <div class="header">
      <div class="user-info">
        <span id="userEmail">No Auth (Dev Mode)</span>
        <button id="logoutBtn" class="logout-btn">Sign Out</button>
      </div>
      <h1>National Account Property <span class="bms-badge">BMS</span></h1>
      <p>National Account Property List</p>
    </div>

    <div class="container">
      <div class="search-section">
        <input type="text" id="searchBox" class="search-box" placeholder="Search across all fields...">
        <div id="stats" class="stats">Loading data...</div>
      </div>

      <div id="content" class="loading">Loading records from DynamoDB...</div>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];

    // ===== DEV MODE: bypass auth entirely =====
    const BYPASS_AUTH = true;

    function formatFieldName(key) {
      return key.replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
    }

    function toggleCard(header) {
      const card = header.parentElement;
      card.classList.toggle('expanded');
    }

    function getRecordTitle(record, index) {
      const rec = record.Record || record.record || '';
      const account = record.account || record.Account || '';
      const loc = record.location_name || record.Location_Name || record.location || '';
      if (account && loc) return `#${rec || (index + 1)} — ${account} — ${loc}`;
      if (account) return `#${rec || (index + 1)} — ${account}`;
      if (loc) return `#${rec || (index + 1)} — ${loc}`;
      return `Record ${rec || (index + 1)}`;
    }

    function displayRecords(records) {
      const content = document.getElementById('content');

      if (!records || records.length === 0) {
        content.innerHTML = '<div class="no-results">No records found matching your search.</div>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'records-grid';

      records.forEach((record, index) => {
        const card = document.createElement('div');
        card.className = 'record-card';

        let fieldsHtml = '';
        Object.keys(record).forEach(key => {
          const value = record[key];
          if (value !== null && value !== undefined && String(value).trim() !== '') {
            fieldsHtml += `
              <div class="field-label">${formatFieldName(key)}</div>
              <div class="field-value">${String(value)}</div>
            `;
          }
        });

        const title = getRecordTitle(record, index);

        card.innerHTML = `
          <div class="record-header" onclick="toggleCard(this)">
            ${title}
            <span class="expand-icon">▼</span>
          </div>
          <div class="record-content">
            <div class="field-grid">
              ${fieldsHtml}
            </div>
          </div>
        `;

        grid.appendChild(card);
      });

      content.innerHTML = '';
      content.appendChild(grid);
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      const total = allData.length;
      const shown = filteredData.length;

      if (shown === total) stats.textContent = `Showing ${total} records`;
      else stats.textContent = `Showing ${shown} of ${total} records`;
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        if (!res.ok) return;
        // If you want, you can use this when your backend returns something like { count: 123 }
        // const data = await res.json();
        // document.getElementById('stats').textContent = `Showing ${data.count} records`;
      } catch {}
    }

    async function searchRecords(query) {
      try {
        const url = `/api/data?search=${encodeURIComponent(query || '')}`;
        const response = await fetch(url, { method: 'GET' });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        allData = data;
        filteredData = data;

        displayRecords(filteredData);
        updateStats();
      } catch (error) {
        console.error('Error loading records:', error);
        document.getElementById('content').innerHTML =
          '<div class="no-results">Error loading data: ' + error.message + '</div>';
      }
    }

    function showMainAppNoAuth() {
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userEmail').textContent = 'No Auth (Dev Mode)';

      loadStats();
      searchRecords('');
    }

    function wireButtons() {
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      if (BYPASS_AUTH) {
        if (loginBtn) loginBtn.classList.add('hidden');
        if (logoutBtn) logoutBtn.classList.add('hidden');
        return;
      }
    }

    document.getElementById('searchBox').addEventListener('input', (e) => {
      searchRecords(e.target.value);
    });

    wireButtons();
    showMainAppNoAuth();
  </script>
</body>
</html>
